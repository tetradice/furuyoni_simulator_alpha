<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ふるよにボードシミュレーター 桜庭</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/semantic/dist/semantic.min.css">
    <style type="text/css">
      body {
        background-color: #FFFFFF;
      }
      .ui.menu .item img.logo {
        margin-right: 1.5em;
      }
      .main.container {
        margin-top: 7em;
      }
      .wireframe {
        margin-top: 2em;
      }
      .ui.footer.segment {
        margin: 5em 0em 0em;
        padding: 5em 0em;
      }
      </style>
  </head>
  <body>
      <div class="ui fixed menu">
          <div class="ui container">
            <div class="header item">
                ふるよにボードシミュレーター 桜庭
            </div>
          </div>
        </div>
        <div class="ui main text container">
          <div class="ui huge loader"></div>
            <button class="ui primary button" id="NEW-BOARD-BUTTON">新しい卓を作る</button>
            <p>新しい卓を作り、自分や他の人が参加できる状態にします。（ユーザー登録は不要です）</p>

            <div class="ui segment" id="RESULT-AREA" style="display: none;">
            <p>新しい卓を作成しました。下記のURLにアクセスすることで、決闘への参加や観戦が可能です。</p>
            <table class="ui definition table">
                <tbody>
                  <tr>
                    <td class="collapsing">プレイヤー1の参加用URL</td>
                    <td><a id="P1-URL" href="#" target="_blank"></a></td>
                  </tr>
                  <tr>
                    <td>プレイヤー2の参加用URL</td>
                    <td><a id="P2-URL" href="#" target="_blank"></a></td>
                  </tr>
                  <tr>
                      <td>観戦用URL</td>
                      <td><a id="WATCH-URL" href="#" target="_blank"></a></td>
                    </tr>
              </tbody></table>
            </div>

            <div class="ui segment" id="HISTORY-AREA" style="margin-top: 4em;">
              <h4 class="ui header">これまでに作成した卓の履歴</h4>
              <p id="HISTORY-NO-DATA-DESC" style="display: none;">作成した卓はありません。</p>
              <div class="ui styled accordion" style="display: none;">
              </div>
              <div class="ui divider"></div>
              <p style="font-size: small;">※履歴はPC（端末）ごとに記録されており、ほかの人には見えません。</p>
            </div>

    <p id='server-time'></p>
    <script type="text/javascript" src="jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script type="text/javascript" src="/semantic/dist/semantic.js"></script>
    <script>
      // var socket = io();
      // var el = document.getElementById('server-time');
      // socket.on('time', function(timeString) {
      //   el.innerHTML = 'Server time: ' + timeString;
      // });

      $(function(){
        var tableHistory = JSON.parse(localStorage.getItem('tableHistory'));
        if(tableHistory === null) tableHistory = [];
        $('.ui.accordion').accordion({duration: 100});

        if(tableHistory.length >= 1){
          tableHistory.forEach(function(data){
            var dt = new Date(data.time);
            $('.ui.accordion').append('<div class="title"><i class="dropdown icon"></i>' + moment(dt).format('YYYY/M/D HH:mm:ss') + 'に作成した卓</div>');
            $('.ui.accordion').append('<div class="content">プレイヤー1の参加用URL: <a target="_blank" href="' + data.p1Url + '">' + data.p1Url + '</a><br />プレイヤー2の参加用URL: <a target="_blank" href="' + data.p2Url + '">' + data.p2Url + '</a><br />観戦用URL: <a target="_blank" href="' + data.watchUrl + '">' + data.watchUrl + '</a><br /></div>');
          });
          $('.ui.accordion').show();
        } else {
          $('#HISTORY-NO-DATA-DESC').show();
        }


        $('#NEW-BOARD-BUTTON').click(function(e){
          $('.ui.loader').addClass('active');

          $.post('/tables.create', function(data, textStatus){
            console.log(data);
            $('#P1-URL').text(data.p1Url).attr('href', data.p1Url);
            $('#P2-URL').text(data.p2Url).attr('href', data.p2Url);
            $('#WATCH-URL').text(data.watchUrl).attr('href', data.watchUrl);
            $('#RESULT-AREA').show();

            // 作った卓のURLをローカルストレージに記憶
            var pushedData = Object.assign({}, data, {time: Date.now()});
            tableHistory.unshift(pushedData);
            localStorage.setItem("tableHistory", JSON.stringify(tableHistory));

            $('.ui.accordion').prepend('<div class="content">プレイヤー1の参加用URL: <a target="_blank" href="' + pushedData.p1Url + '">' + pushedData.p1Url + '</a><br />プレイヤー2の参加用URL: <a target="_blank" href="' + pushedData.p2Url + '">' + pushedData.p2Url + '</a><br />観戦用URL: <a target="_blank" href="' + pushedData.watchUrl + '">' + pushedData.watchUrl + '</a><br /></div>');
            $('.ui.accordion').prepend('<div class="title"><i class="dropdown icon"></i>' + moment(pushedData.time).format('YYYY/M/D HH:mm:ss') + 'に作成した卓</div>');

            $('.ui.loader').removeClass('active');

          });
        });
      });
    </script>
     </div>
  </body>
</html>